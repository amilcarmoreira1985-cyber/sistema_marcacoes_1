<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Marca√ß√µes - M√°quinas de Lavar</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    /* Reset b√°sico */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 2.5rem;
      color: #1e40af;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #64748b;
      font-size: 1.1rem;
    }
    
    /* Machine Selection */
    .machine-selector {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .machine-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      text-transform: capitalize;
      font-size: 1rem;
    }
    
    .machine-btn.active {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .machine-cachenos {
      background: #fee2e2;
      border: 2px solid #ef4444;
      color: #991b1b;
    }
    
    .machine-cachenos.active {
      background: #ef4444;
      color: white;
    }
    
    .machine-zma {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      color: #92400e;
    }
    
    .machine-zma.active {
      background: #f59e0b;
      color: white;
    }
    
    .machine-oficiais {
      background: #dbeafe;
      border: 2px solid #3b82f6;
      color: #1e3a8a;
    }
    
    .machine-oficiais.active {
      background: #3b82f6;
      color: white;
    }
    
    /* Date Selection */
    .date-selector {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .date-select {
      padding: 12px 16px;
      border: 2px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
    }
    
    /* Grelha */
    .grid-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .grid-header {
      padding: 16px 20px;
      background: #1e40af;
      color: white;
    }
    
    .grid-title {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .grid-subtitle {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 4px;
    }
    
    .maintenance-info {
      background: #fee2e2;
      color: #991b1b;
      padding: 8px;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      padding: 20px;
    }
    
    .time-slot {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .time-slot:hover {
      background: #f8fafc;
      transform: translateY(-2px);
    }
    
    .time-label {
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
    }
    
    .booking-info {
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-size: 0.875rem;
    }
    
    .booking-cachenos {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }
    
    .booking-zma {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      color: #92400e;
    }
    
    .booking-oficiais {
      background: #dbeafe;
      border: 1px solid #3b82f6;
      color: #1e3a8a;
    }
    
    .available {
      color: #64748b;
      font-style: italic;
      text-align: center;
    }
    
    .unavailable {
      background: #f8fafc;
      color: #94a3b8;
      font-style: italic;
      text-align: center;
      font-size: 0.8rem;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      transform: scale(0.9);
      transition: transform 0.3s;
    }
    
    .modal-overlay.active .modal {
      transform: scale(1);
    }
    
    .modal-header {
      padding: 16px 20px;
      background: #1e40af;
      color: white;
      border-radius: 12px 12px 0 0;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .error-message {
      background: #fee2e2;
      border: 2px solid #f87171;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      color: #991b1b;
      font-weight: 600;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #334155;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #2563eb;
    }
    
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #334155;
    }
    
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    /* Mensagens */
    .success-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    /* Informa√ß√£o */
    .info-box {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .info-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 12px;
    }
    
    .info-list {
      list-style: none;
    }
    
    .info-item {
      color: #334155;
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }
    
    .info-item::before {
      content: "‚úÖ";
      position: absolute;
      left: 0;
    }
    
    /* Anima√ß√µes */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Responsivo */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Status de conex√£o */
    .connection-status {
      text-align: center;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .connected {
      background-color: #dcfce7;
      color: #166534;
    }
    
    .disconnected {
      background-color: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Status de conex√£o -->
    <div id="connectionStatus" class="connection-status disconnected">
      A conectar ao servidor...
    </div>
    
    <!-- Header -->
    <div class="header">
      <h1>Sistema de Marca√ß√µes</h1>
      <p>M√°quinas de Lavar</p>
    </div>

    <!-- Machine Selection -->
    <div class="machine-selector">
      <button class="machine-btn machine-cachenos active" data-machine="Cachenos">Cachenos</button>
      <button class="machine-btn machine-zma" data-machine="ZMA">ZMA</button>
      <button class="machine-btn machine-oficiais" data-machine="Oficiais/Sargentos">Oficiais/Sargentos</button>
    </div>

    <!-- Date Selection -->
    <div class="date-selector">
      <select class="date-select" id="dateSelect"></select>
    </div>

    <!-- Grid View -->
    <div class="grid-container">
      <div class="grid-header">
        <div class="grid-title">Folha de Marca√ß√µes - <span id="machineTitle">Cachenos</span></div>
        <div class="grid-subtitle" id="gridSubtitle">Data: --/--/-- (---)</div>
      </div>
      <div class="maintenance-info" id="maintenanceInfo" style="display: none;">
        Segundas-feiras das 07:00 √†s 12:00: Manuten√ß√£o (sem marca√ß√µes)
      </div>
      <div class="grid" id="timeGrid"></div>
    </div>

    <!-- Modal para marca√ß√£o -->
    <div class="modal-overlay" id="bookingModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Registar Marca√ß√£o</div>
        </div>
        <div class="modal-body">
          <!-- Mensagem de erro que aparece no modal -->
          <div id="modalErrorMessage" class="error-message" style="display: none;"></div>
          
          <div class="form-group">
            <label class="form-label">√öltimo Nome *</label>
            <input type="text" id="modalLastName" class="form-input" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">N√∫mero de Batalha *</label>
            <input type="text" id="modalBattleNumber" class="form-input" required>
          </div>
          
          <div id="modalTimeInfo" style="margin-top: 8px; padding: 8px; background: #f1f5f9; border-radius: 6px; font-size: 0.9rem;">
            Hor√°rio: <strong id="modalTime"></strong>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelBooking">Cancelar</button>
          <button class="btn btn-primary" id="confirmBooking">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Modal para cancelar marca√ß√£o -->
    <div class="modal-overlay" id="cancelModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Cancelar Marca√ß√£o</div>
        </div>
        <div class="modal-body">
          <p>Tem a certeza que pretende cancelar a marca√ß√£o de <strong id="cancelName"></strong> (<strong id="cancelBattleNumber"></strong>)?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelCancel">Cancelar</button>
          <button class="btn btn-danger" id="confirmCancel">Confirmar Cancelamento</button>
        </div>
      </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message" style="display: none;">
      Marca√ß√£o registada com sucesso!
    </div>

    <!-- Information Box -->
    <div class="info-box">
      <h3 class="info-title">Informa√ß√£o:</h3>
      <ul class="info-list">
        <li class="info-item"‚ö†Ô∏è Os ciclos n√£o devem passar de 01h</li>
        <li class="info-item">Para equidade, evite marcar sempre o mesmo dia/hor√°rio</li>
        <li class="info-item">Clique num hor√°rio livre para registar sua marca√ß√£o</li>
        <li class="info-item">Todas as marca√ß√µes s√£o guardadas automaticamente no servidor</li>
        <li class="info-item">Marca√ß√µes por data espec√≠fica (pr√≥ximos 30 dias)</li>
        <li class="info-item">As marca√ß√µes s√£o atualizadas em tempo real para todos os utilizadores</li>
        <li class="info-item">Segundas-feiras das 07:00 √†s 12:00: Manuten√ß√£o (sem marca√ß√µes)</li>
      </ul>
    </div>
  </div>

  <script>
    // üî• Configura√ß√£o do Firebase (substituir pelos seus dados)
    const firebaseConfig = {
      apiKey: "AIzaSyCEHUiu2_qKMFfk73rQdotGA9lOXtcajNg",
      authDomain: "sistema-marcacoes.firebaseapp.com",
      databaseURL: "https://sistema-marcacoes-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sistema-marcacoes",
      storageBucket: "sistema-marcacoes.firebasestorage.app",
      messagingSenderId: "360746863117",
     appId: "1:360746863117:web:2e94baa09cebb465b5a344"
   };


    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Dados do sistema
    const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    const machines = ['Cachenos', 'ZMA', 'Oficiais/Sargentos'];
    
    // Gerar hor√°rios (07:00-08:00 at√© 23:00-00:00)
    const generateHours = () => {
      const hours = [];
      for (let i = 7; i < 24; i++) {
        const start = i.toString().padStart(2, '0');
        const end = (i + 1).toString().padStart(2, '0');
        hours.push(`${start}:00-${end === '24' ? '00' : end}:00`);
      }
      return hours;
    };
    
    const hours = generateHours();
    
    // Gerar pr√≥ximos 30 dias
    const generateDates = () => {
      const dates = [];
      const today = new Date();
      for (let i = 0; i < 30; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dateString = date.toISOString().split('T')[0];
        dates.push({
          value: dateString,
          label: dateString
        });
      }
      return dates;
    };
    
    // Verificar se √© segunda-feira e hor√°rio de manuten√ß√£o
    const isMaintenanceTime = (dateString, timeString) => {
      const date = new Date(dateString);
      const dayOfWeek = date.getDay(); // 1 = segunda-feira
      
      if (dayOfWeek !== 1) return false; // N√£o √© segunda-feira
      
      // Verificar hor√°rio: 07:00-08:00 at√© 11:00-12:00
      const hour = parseInt(timeString.split(':')[0]);
      return hour >= 7 && hour < 12;
    };
    
    // Estado da aplica√ß√£o
    let state = {
      activeMachine: 'Cachenos',
      activeDate: '',
      bookings: {},
      selectedTimeSlot: null,
      selectedTime: '',
      selectedBooking: null
    };
    
    // Elementos DOM
    const elements = {
      connectionStatus: document.getElementById('connectionStatus'),
      machineBtns: document.querySelectorAll('.machine-btn'),
      dateSelect: document.getElementById('dateSelect'),
      gridSubtitle: document.getElementById('gridSubtitle'),
      machineTitle: document.getElementById('machineTitle'),
      maintenanceInfo: document.getElementById('maintenanceInfo'),
      timeGrid: document.getElementById('timeGrid'),
      bookingModal: document.getElementById('bookingModal'),
      cancelModal: document.getElementById('cancelModal'),
      modalErrorMessage: document.getElementById('modalErrorMessage'),
      modalLastName: document.getElementById('modalLastName'),
      modalBattleNumber: document.getElementById('modalBattleNumber'),
      modalTime: document.getElementById('modalTime'),
      modalTimeInfo: document.getElementById('modalTimeInfo'),
      cancelBooking: document.getElementById('cancelBooking'),
      confirmBooking: document.getElementById('confirmBooking'),
      cancelCancel: document.getElementById('cancelCancel'),
      confirmCancel: document.getElementById('confirmCancel'),
      cancelName: document.getElementById('cancelName'),
      cancelBattleNumber: document.getElementById('cancelBattleNumber'),
      successMessage: document.getElementById('successMessage')
    };
    
    // Datas dispon√≠veis
    const dates = generateDates();
    
    // Inicializar
    const init = () => {
      // Preencher select de datas
      dates.forEach(date => {
        const option = document.createElement('option');
        option.value = date.value;
        option.textContent = `${date.value} (${getDayOfWeek(date.value)})`;
        elements.dateSelect.appendChild(option);
      });
      
      // Carregar estado inicial
      state.activeDate = dates[0].value;
      
      // Atualizar UI
      updateUI();
      setupEventListeners();
      
      // Iniciar escuta em tempo real
      startRealtimeListener();
      
      // Monitorizar estado da conex√£o
      monitorConnection();
    };
    
    // Monitorizar estado da conex√£o
    const monitorConnection = () => {
      const connectedRef = firebase.database().ref('.info/connected');
      connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
          elements.connectionStatus.textContent = 'Conectado ao servidor';
          elements.connectionStatus.className = 'connection-status connected';
        } else {
          elements.connectionStatus.textContent = 'Desconectado do servidor';
          elements.connectionStatus.className = 'connection-status disconnected';
        }
      });
    };
    
    // Iniciar escuta em tempo real
    const startRealtimeListener = () => {
      const bookingsRef = database.ref('bookings/' + state.activeMachine + '/' + state.activeDate);
      
      bookingsRef.on('value', (snapshot) => {
        state.bookings[state.activeMachine] = snapshot.val() || {};
        updateGrid();
      });
      
      // Atualizar escuta quando a m√°quina ou data mudar
      const updateListener = () => {
        bookingsRef.off(); // Remover listener anterior
        const newRef = database.ref('bookings/' + state.activeMachine + '/' + state.activeDate);
        newRef.on('value', (snapshot) => {
          state.bookings[state.activeMachine] = snapshot.val() || {};
          updateGrid();
        });
      };
      
      // Atualizar t√≠tulo da m√°quina
      elements.machineTitle.textContent = state.activeMachine;
    };
    
    // Obter dia da semana
    const getDayOfWeek = (dateString) => {
      const date = new Date(dateString);
      return days[date.getDay()];
    };
    
    // Formatar data
    const formatDate = (dateString) => {
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: '2-digit' });
    };
    
    // Verificar se hor√°rio est√° dispon√≠vel
    const isTimeAvailable = (date, time) => {
      // Hor√°rio de manuten√ß√£o nas segundas
      if (isMaintenanceTime(date, time)) return false;
      
      const machineBookings = state.bookings[state.activeMachine];
      if (!machineBookings || !machineBookings[date]) return true;
      return !machineBookings[date].some(booking => booking.time === time);
    };
    
    // Verificar se usu√°rio j√° tem marca√ß√£o neste dia
    const hasBookingForDay = (battleNumber, targetDate) => {
      const machineBookings = state.bookings[state.activeMachine];
      if (!machineBookings || !machineBookings[targetDate]) return false;
      
      return machineBookings[targetDate].some(booking => 
        booking.battleNumber === battleNumber
      );
    };
    
    // Obter todas as marca√ß√µes da semana para um usu√°rio
    const getUserBookingsThisWeek = (battleNumber, targetDate) => {
      const target = new Date(targetDate);
      const targetWeekStart = new Date(target);
      targetWeekStart.setDate(target.getDate() - target.getDay()); // Domingo da semana
      targetWeekStart.setHours(0, 0, 0, 0);
      
      const targetWeekEnd = new Date(targetWeekStart);
      targetWeekEnd.setDate(targetWeekStart.getDate() + 6); // S√°bado da semana
      targetWeekEnd.setHours(23, 59, 59, 999);
      
      let count = 0;
      for (const machine in state.bookings) {
        for (const dateStr in state.bookings[machine]) {
          const date = new Date(dateStr);
          if (date >= targetWeekStart && date <= targetWeekEnd) {
            const dayBookings = state.bookings[machine][dateStr];
            const userBooking = dayBookings.find(b => b.battleNumber === battleNumber);
            if (userBooking) {
              count++;
            }
          }
        }
      }
      return count;
    };
    
    // Verificar se usu√°rio j√° marcou este mesmo dia da semana e hor√°rio este m√™s
    const hasUserRepeatedSchedule = (lastName, battleNumber, targetDate, targetTime) => {
      const target = new Date(targetDate);
      const targetDayOfWeek = target.getDay();
      const targetHour = parseInt(targetTime.split(':')[0]);
      
      // Verificar todas as marca√ß√µes do usu√°rio (mesmo n√∫mero de batalha)
      for (const machine in state.bookings) {
        for (const dateStr in state.bookings[machine]) {
          const dateBookings = state.bookings[machine][dateStr];
          const bookingDate = new Date(dateStr);
          
          // Verificar se √© do mesmo usu√°rio (mesmo n√∫mero de batalha)
          const userBooking = dateBookings.find(b => 
            b.battleNumber === battleNumber
          );
          
          if (userBooking) {
            const bookingHour = parseInt(userBooking.time.split(':')[0]);
            const bookingDayOfWeek = bookingDate.getDay();
            
            // Se mesmo dia da semana e mesmo hor√°rio (mesma hora de in√≠cio)
            if (bookingDayOfWeek === targetDayOfWeek && bookingHour === targetHour) {
              return true;
            }
          }
        }
      }
      return false;
    };
    
    // Verificar se j√° existe algu√©m com o mesmo n√∫mero de batalha mas nome diferente
    const hasNameConflictForBattleNumber = (lastName, battleNumber, excludeBookingId = null) => {
      for (const machine in state.bookings) {
        for (const date in state.bookings[machine]) {
          for (const booking of state.bookings[machine][date]) {
            if (booking.battleNumber === battleNumber && 
                booking.lastName.toLowerCase() !== lastName.toLowerCase() && 
                booking.id !== excludeBookingId) {
              return booking;
            }
          }
        }
      }
      return null;
    };
    
    // Atualizar UI
    const updateUI = () => {
      // Atualizar bot√µes de m√°quina
      elements.machineBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.machine === state.activeMachine);
      });
      
      // Atualizar select de data
      elements.dateSelect.value = state.activeDate;
      
      // Atualizar subt√≠tulo da grelha
      const dayOfWeek = getDayOfWeek(state.activeDate);
      elements.gridSubtitle.textContent = `Data: ${formatDate(state.activeDate)} (${dayOfWeek})`;
      
      // Atualizar t√≠tulo da m√°quina
      elements.machineTitle.textContent = state.activeMachine;
      
      // Mostrar aviso de manuten√ß√£o se for segunda-feira
      const isMonday = new Date(state.activeDate).getDay() === 1;
      elements.maintenanceInfo.style.display = isMonday ? 'block' : 'none';
      
      // Atualizar grelha
      updateGrid();
    };
    
    // Atualizar grelha
    const updateGrid = () => {
      elements.timeGrid.innerHTML = '';
      hours.forEach(hour => {
        const slot = document.createElement('div');
        slot.className = 'time-slot';
        
        const label = document.createElement('div');
        label.className = 'time-label';
        label.textContent = hour;
        slot.appendChild(label);
        
        // Verificar se √© hor√°rio de manuten√ß√£o
        if (isMaintenanceTime(state.activeDate, hour)) {
          const unavailable = document.createElement('div');
          unavailable.className = 'unavailable';
          unavailable.textContent = 'Manuten√ß√£o';
          slot.appendChild(unavailable);
        } else {
          const booking = getBooking(state.activeDate, hour);
          if (booking) {
            const info = document.createElement('div');
            info.className = `booking-info booking-${state.activeMachine.toLowerCase().replace('/', '')}`;
            info.innerHTML = `
              <div>${booking.lastName}</div>
              <div style="font-size: 0.8rem; margin-top: 4px;">${booking.battleNumber}</div>
              <div style="font-size: 0.7rem; margin-top: 4px; cursor: pointer; color: #ef4444;" 
                   onclick="openCancelModal('${booking.id}', '${booking.lastName}', '${booking.battleNumber}', '${hour}')">
                Cancelar
              </div>
            `;
            slot.appendChild(info);
          } else {
            const available = document.createElement('div');
            available.className = 'available';
            available.textContent = 'Clique para marcar';
            slot.appendChild(available);
            
            // Adicionar evento de clique para hor√°rios livres
            slot.addEventListener('click', () => {
              state.selectedTimeSlot = slot;
              state.selectedTime = hour;
              openBookingModal(hour);
            });
          }
        }
        
        elements.timeGrid.appendChild(slot);
      });
    };
    
    // Obter marca√ß√£o
    const getBooking = (date, time) => {
      const machineBookings = state.bookings[state.activeMachine];
      if (!machineBookings || !machineBookings[date]) return null;
      return machineBookings[date].find(booking => booking.time === time);
    };
    
    // Abrir modal de marca√ß√£o
    const openBookingModal = (time) => {
      elements.modalTime.textContent = time;
      elements.bookingModal.classList.add('active');
      elements.modalLastName.value = '';
      elements.modalBattleNumber.value = '';
      elements.modalErrorMessage.style.display = 'none';
      elements.modalLastName.focus();
    };
    
    // Fechar modal de marca√ß√£o
    const closeBookingModal = () => {
      elements.bookingModal.classList.remove('active');
      state.selectedTimeSlot = null;
      state.selectedTime = '';
    };
    
    // Abrir modal de cancelamento
    const openCancelModal = (bookingId, lastName, battleNumber, time) => {
      state.selectedBooking = {
        id: bookingId,
        lastName: lastName,
        battleNumber: battleNumber,
        time: time
      };
      
      elements.cancelName.textContent = lastName;
      elements.cancelBattleNumber.textContent = battleNumber;
      elements.cancelModal.classList.add('active');
    };
    
    // Fechar modal de cancelamento
    const closeCancelModal = () => {
      elements.cancelModal.classList.remove('active');
      state.selectedBooking = null;
    };
    
    // Mostrar mensagem de erro no modal
    const showErrorMessage = (message) => {
      elements.modalErrorMessage.textContent = message;
      elements.modalErrorMessage.style.display = 'block';
    };
    
    // Mostrar mensagem de sucesso
    const showSuccess = (message) => {
      elements.successMessage.textContent = message;
      elements.successMessage.style.display = 'block';
      setTimeout(() => {
        elements.successMessage.style.display = 'none';
      }, 3000);
    };
    
    // Configurar listeners
    const setupEventListeners = () => {
      // Bot√µes de m√°quina
      elements.machineBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          state.activeMachine = btn.dataset.machine;
          updateUI();
          startRealtimeListener(); // Atualizar escuta em tempo real
        });
      });
      
      // Select de data
      elements.dateSelect.addEventListener('change', (e) => {
        state.activeDate = e.target.value;
        updateUI();
        startRealtimeListener(); // Atualizar escuta em tempo real
      });
      
      // Modal - Cancelar marca√ß√£o
      elements.cancelBooking.addEventListener('click', () => {
        closeBookingModal();
      });
      
      // Modal - Confirmar marca√ß√£o
      elements.confirmBooking.addEventListener('click', () => {
        const lastName = elements.modalLastName.value.trim();
        const battleNumber = elements.modalBattleNumber.value.trim();
        const time = state.selectedTime;
        
        if (!lastName || !battleNumber || !time) {
          showErrorMessage('Por favor, preencha todos os campos.');
          return;
        }
        
        // Verificar se √© hor√°rio de manuten√ß√£o
        if (isMaintenanceTime(state.activeDate, time)) {
          showErrorMessage('Este hor√°rio √© de manuten√ß√£o e n√£o est√° dispon√≠vel para marca√ß√µes.');
          return;
        }
        
        // Verificar se usu√°rio j√° tem marca√ß√£o neste dia
        if (hasBookingForDay(battleNumber, state.activeDate)) {
          showErrorMessage('J√° tem uma marca√ß√£o neste dia. Apenas uma por dia.');
          return;
        }
        
        // Verificar se usu√°rio j√° tem marca√ß√£o esta semana
        const weeklyBookings = getUserBookingsThisWeek(battleNumber, state.activeDate);
        if (weeklyBookings >= 1) {
          showErrorMessage('J√° tem uma marca√ß√£o esta semana. Apenas uma por semana.');
          return;
        }
        
        // Nova verifica√ß√£o: mesmo n√∫mero de batalha com nome diferente
        const nameConflict = hasNameConflictForBattleNumber(lastName, battleNumber);
        if (nameConflict) {
          showErrorMessage(`O n√∫mero de batalha ${battleNumber} j√° est√° associado a ${nameConflict.lastName}. 
                    O mesmo n√∫mero de batalha deve usar sempre o mesmo nome.`);
          return;
        }
        
        // Verificar se usu√°rio j√° marcou este mesmo dia da semana e hor√°rio
        if (hasUserRepeatedSchedule(lastName, battleNumber, state.activeDate, time)) {
          showErrorMessage('Ol√°! Para que todos tenham oportunidade, pedimos que varie os dias/hor√°rios das suas marca√ß√µes. Obrigado pela colabora√ß√£o!');
          return;
        }
        
        // Verificar se hor√°rio est√° ocupado
        const slotTaken = state.bookings[state.activeMachine] && state.bookings[state.activeMachine][state.activeDate] 
          ? state.bookings[state.activeMachine][state.activeDate].some(b => b.time === time) 
          : false;
          
        if (slotTaken) {
          const booking = state.bookings[state.activeMachine][state.activeDate].find(b => b.time === time);
          showErrorMessage(`Hor√°rio ocupado por ${booking.lastName}. Escolha outro.`);
          return;
        }
        
        // Criar nova marca√ß√£o
        const newBooking = {
          id: Date.now().toString(),
          lastName,
          battleNumber,
          time,
          date: state.activeDate,
          machine: state.activeMachine
        };
        
        // Salvar no Firebase
        const ref = database.ref('bookings/' + state.activeMachine + '/' + state.activeDate);
        ref.push(newBooking)
          .then(() => {
            closeBookingModal();
            showSuccess('Marca√ß√£o registada com sucesso!');
          })
          .catch((error) => {
            showErrorMessage('Erro ao registar marca√ß√£o: ' + error.message);
          });
      });
      
      // Fechar modal de marca√ß√£o ao clicar fora
      elements.bookingModal.addEventListener('click', (e) => {
        if (e.target === elements.bookingModal) {
          closeBookingModal();
        }
      });
      
      // Fechar modal de cancelamento ao clicar fora
      elements.cancelModal.addEventListener('click', (e) => {
        if (e.target === elements.cancelModal) {
          closeCancelModal();
        }
      });
      
      // Modal - Cancelar cancelamento
      elements.cancelCancel.addEventListener('click', () => {
        closeCancelModal();
      });
      
      // Modal - Confirmar cancelamento
      elements.confirmCancel.addEventListener('click', () => {
        if (!state.selectedBooking) return;
        
        // Encontrar a marca√ß√£o no Firebase
        const ref = database.ref('bookings/' + state.activeMachine + '/' + state.activeDate);
        ref.once('value')
          .then((snapshot) => {
            const bookings = snapshot.val();
            if (!bookings) return;
            
            // Procurar a marca√ß√£o espec√≠fica
            let bookingKey = null;
            for (const key in bookings) {
              if (bookings[key].id === state.selectedBooking.id) {
                bookingKey = key;
                break;
              }
            }
            
            if (bookingKey) {
              // Remover a marca√ß√£o
              ref.child(bookingKey).remove()
                .then(() => {
                  closeCancelModal();
                  showSuccess('Marca√ß√£o cancelada com sucesso!');
                })
                .catch((error) => {
                  showErrorMessage('Erro ao cancelar marca√ß√£o: ' + error.message);
                });
            } else {
              showErrorMessage('Marca√ß√£o n√£o encontrada');
              closeCancelModal();
            }
          })
          .catch((error) => {
            showErrorMessage('Erro ao cancelar marca√ß√£o: ' + error.message);
          });
      });
      
      // Fechar com ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeBookingModal();
          closeCancelModal();
        }
      });
    };
    
    // Inicializar aplica√ß√£o
    init();
  </script>
</body>
</html>
